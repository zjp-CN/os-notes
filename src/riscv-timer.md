记录我查的专业名词，大部分解释来自 kimi (AI)。

# 如何设置时钟中断

问：risc-v 如何设置时钟中断，在 M 模式和 S 模式分别说明

答：在RISC-V架构中，设置时钟中断主要涉及到几个关键的寄存器和步骤，这些步骤在机器模式（M模式）和监管者模式（S模式）中有所不同。以下是在两种模式下设置时钟中断的一般流程：

* M模式（Machine Mode）设置时钟中断：
  1. **初始化时钟中断寄存器**：首先需要初始化`mtime`（当前时间计数器）和`mtimecmp`（时钟中断比较寄存器）。`mtimecmp`通常被设置为`mtime`的当前值加上某个间隔，从而在达到这个值时触发中断。
  2. **设置中断使能位**：通过设置`mie`（机器中断使能寄存器）中的`MTIE`（时钟中断使能位），来使能时钟中断。
  3. **配置中断向量**：设置`mtvec`（机器中断向量寄存器），用于定义中断服务程序的入口地址。
  4. **全局中断使能**：确保`mstatus`寄存器中的`MIE`位被设置，以允许全局中断。

* S模式（Supervisor Mode）设置时钟中断：
  1. **使能S模式时钟中断**：在S模式下，需要设置`sie`（监管者中断使能寄存器）中的`STIE`（时钟中断使能位）来使能时钟中断。
  2. **处理M模式到S模式的中断委派**：如果系统配置了中断委派，M模式可以将时钟中断的响应权交给S模式处理。这通过设置`mideleg`（机器中断委派寄存器）来实现。
  3. **S模式中断处理**：S模式下的操作系统需要配置自己的中断处理程序，并在`stvec`（监管者中断向量寄存器）中设置中断服务程序的入口地址。
  4. **软件触发S模式中断**：在M模式下处理时钟中断后，可以通过向`sip`（监管者中断挂起寄存器）中的`SSIP`（软件中断挂起位）写入值来触发S模式下的软件中断，从而将控制权转交给S模式的中断处理程序。

在M模式下，时钟中断是直接由硬件触发的，而在S模式下，时钟中断可能需要通过M模式下的中断处理程序来间接触发。这是因为时钟中断默认是M模式中断，不能直接委派给S模式，除非通过软件触发的方式。在S模式下，操作系统可以利用时钟中断来进行任务调度、计时等功能的实现。

# mideleg

`mideleg`（Machine Interrupt Delegation Register）是RISC-V架构中的一个控制和状态寄存器（CSR），用于定义哪些中断可以被委派到监管者模式（S-Mode）。这个寄存器允许机器模式（M-Mode）将某些中断的处理权交给S-Mode，从而允许操作系统在S-Mode下处理这些中断，而不是直接在M-Mode下处理。

* mideleg寄存器的主要功能：
  - **中断委派**：`mideleg`寄存器中的每个位对应一种中断类型。如果某位被设置为1，则表示对应的中断可以被委派到S-Mode。
  - **减少M-Mode中断处理**：通过委派中断，可以减少M-Mode需要直接处理的中断数量，从而允许操作系统在S-Mode下更灵活地管理中断。

* mideleg寄存器的位定义：
  - 通常，`mideleg`寄存器的位与`mcause`寄存器中的中断原因编码相对应。例如，如果`mcause`中的第i位表示某种中断，则`mideleg`中的第i位可以用来控制是否将该中断委派到S-Mode。
  - 标准RISC-V中断类型包括软件中断、定时器中断和外部中断等，它们在`mideleg`中都有对应的位。

* 使用mideleg寄存器的步骤：
  1. **确定中断类型**：确定需要委派的中断类型，并找到`mideleg`中对应的位。
  2. **设置委派位**：将`mideleg`中对应中断类型的位设置为1，以启用对该中断类型的委派。
  3. **配置S-Mode中断处理**：在S-Mode下配置相应的中断处理程序，并确保`sie`寄存器中对应的中断使能位也被设置，以便S-Mode可以接收并处理这些中断。

* 注意事项：
  - **中断委派的限制**：并非所有中断都可以被委派。例如，非屏蔽中断（NMI）通常不能被委派。
  - **硬件实现差异**：不同的RISC-V实现可能对中断委派的支持程度不同。有些实现可能不支持将某些类型的中断委派给S-Mode。

`mideleg`寄存器的使用可以提高系统的灵活性和效率，允许操作系统在适当的特权级别处理中断，同时减少对M-Mode的依赖。

> 问：mideleg 的设置权限在 M 还是 S
> 
> 答：`mideleg`（Machine Interrupt Delegation Register）的设置权限在机器模式（M模式）。这是因为`mideleg`是一个机器级别的控制寄存器，它决定了哪些中断可以被委派到监管者模式（S模式）。只有具备修改机器级别寄存器权限的代码才能设置`mideleg`，即在M模式下运行的代码或者具有相应权限的固件或操作系统代码。
> 
> 以下是`mideleg`设置的一般流程：
> 
> 1. **进入M模式**：如果当前不在M模式，需要首先从当前模式（无论是U模式、S模式还是其他）切换到M模式。这通常通过触发异常或中断，或者使用特定的特权指令来实现。
> 
> 2. **修改`mideleg`**：在M模式下，具有权限的代码可以读取`mideleg`寄存器的当前值，然后修改它以委派所需的中断到S模式。这通常涉及到设置`mideleg`寄存器中对应中断类型的位。
> 
> 3. **保存并退出**：修改完`mideleg`后，代码需要保存更改并可能需要退出M模式，返回到之前的执行模式。
> 
> 由于`mideleg`的修改直接影响到系统的中断处理流程，因此这种修改通常由系统固件、引导加载程序或操作系统内核在系统启动或配置过程中进行，而不是由普通的用户模式应用程序执行。此外，出于安全和稳定性的考虑，只有经过验证和授权的代码才能进行这类更改。

# wfi 指令

`wfi`（Wait For Interrupt）是RISC-V指令集架构中的一项指令，用于实现低功耗等待状态。当处理器执行`wfi`指令时，它会进入一种特殊的休眠模式，在这种模式下，处理器会暂停执行后续指令，直到发生以下任一事件才会被唤醒：

1. **中断**：如果处理器配置为响应中断，那么当有中断发生时，处理器会从`wfi`状态唤醒并处理中断。
2. **外部事件**：某些实现可能允许其他类型的外部事件唤醒处理器，例如系统信号或特定的硬件信号。

`wfi`指令的主要特点和用途包括：

- **节能**：在不需要立即响应的情况下，使用`wfi`可以减少处理器的能耗，因为它允许处理器在等待事件发生时进入低功耗状态。
- **响应性**：尽管处理器在执行`wfi`时会暂停执行，但它仍然能够快速响应中断或其他唤醒事件，从而保证了系统的响应性。
- **编程模型**：`wfi`为编程模型提供了一种机制，使得软件能够在不需要频繁轮询的情况下等待事件发生。

在操作系统或设备驱动程序中，`wfi`可以用于实现以下场景：

- **空闲循环**：操作系统的调度器可能会在没有任务可调度时使用`wfi`，以减少CPU的能耗。
- **等待I/O操作**：驱动程序在等待I/O操作完成时可以使用`wfi`，以避免在CPU上浪费资源。
- **低功耗模式**：在电池供电的设备中，`wfi`可以作为进入低功耗状态的一种手段。

使用`wfi`指令时，需要注意以下几点：

- **中断使能**：确保处理器已经使能了所需的中断，否则`wfi`可能永远不会被唤醒。
- **上下文保存**：在执行`wfi`之前，可能需要保存处理器的状态，以便在唤醒后能够恢复执行。
- **实现依赖性**：`wfi`的行为可能依赖于具体的RISC-V实现，因此在不同的硬件上可能有不同的行为。

总的来说，`wfi`是RISC-V架构中一项重要的指令，它为实现节能和高效的中断驱动编程提供了支持。

# 如何触发软件中断

在RISC-V架构中，触发软件中断通常涉及以下几个步骤：

1. **使能软件中断**：在RISC-V的中断使能寄存器（`mie`）中设置软件中断使能位（`MSIE`）。这样，当软件中断被触发时，处理器将响应这个中断。

2. **写入软件中断挂起寄存器**：通过向软件中断挂起寄存器（`sip`）写入1，可以触发软件中断。在RISC-V中，`sip`寄存器的`SSIP`位（Software Interrupt Pending bit）用于触发软件中断。

3. **处理软件中断**：一旦软件中断被触发，处理器将执行中断服务程序。在S模式下，这通常涉及到从`stvec`寄存器指定的中断向量地址跳转，并执行相应的中断处理代码。

4. **清除软件中断**：软件中断处理完成后，需要清除软件中断挂起位，通常是通过向`sip`寄存器写入0来完成。这表示软件中断已经被处理，不会再触发中断流程。

5. **返回中断**：中断处理完成后，使用中断返回指令（如`mret`或`sret`）返回到中断发生前执行的程序位置。

请注意，具体的实现细节可能会根据不同的RISC-V实现和操作系统而有所不同。上述步骤提供了一个通用的触发和处理软件中断的流程。

> S 模式不直接控制时钟中断和软件中断，而是使用 ecall 指令请求 M 模式设置定时器或代表它发送处理器间中断。此软件约定是监管程序二进制接口
> （Supervisor Binary Interface）的一部分。
> 
> src: The RISC-V Reader
